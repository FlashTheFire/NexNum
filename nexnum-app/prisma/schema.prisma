generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  role         Role       @default(USER)
  isBanned     Boolean    @default(false) @map("is_banned")
  auditLogs    AuditLog[]
  numbers      Number[]
  wallet       Wallet?

  @@map("users")
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique @map("user_id")
  createdAt    DateTime            @default(now()) @map("created_at")
  transactions WalletTransaction[]
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model WalletTransaction {
  id             String   @id @default(uuid())
  walletId       String   @map("wallet_id")
  amount         Decimal  @db.Decimal(12, 2)
  type           String
  description    String?
  idempotencyKey String?  @unique @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at")
  wallet         Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@map("wallet_transactions")
}

model Number {
  id           String       @id @default(uuid())
  phoneNumber  String       @map("phone_number")
  countryCode  String       @map("country_code")
  countryName  String?      @map("country_name")
  serviceName  String?      @map("service_name")
  serviceCode  String?      @map("service_code")
  price        Decimal      @db.Decimal(8, 2)
  status       String       @default("available")
  ownerId      String?      @map("owner_id")
  activationId String?      @map("activation_id")
  provider     String?
  expiresAt    DateTime?    @map("expires_at")
  purchasedAt  DateTime?    @map("purchased_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  owner        User?        @relation(fields: [ownerId], references: [id])
  smsMessages  SmsMessage[]

  @@index([ownerId])
  @@index([status])
  @@index([status, createdAt])           // List by status ordered by date
  @@index([ownerId, status])             // User's numbers by status
  @@index([provider, status])            // Provider stats
  @@index([expiresAt])                   // Expiring numbers cleanup
  @@map("numbers")
}

model SmsMessage {
  id         String   @id @default(uuid())
  numberId   String   @map("number_id")
  sender     String?
  content    String?
  code       String?
  receivedAt DateTime @default(now()) @map("received_at")
  number     Number   @relation(fields: [numberId], references: [id], onDelete: Cascade)

  @@index([numberId])
  @@map("sms_messages")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

model Country {
  id           String           @id @default(uuid())
  externalId   String           @map("external_id")
  name         String
  slug         String
  phoneCode    String           @map("phone_code")
  iconUrl      String?          @map("icon_url")
  popular      Int              @default(0)
  provider     String
  isActive     Boolean          @default(true) @map("is_active")
  lastSyncedAt DateTime         @default(now()) @map("last_synced_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  services     ServicePricing[]

  @@unique([externalId, provider])
  @@index([provider])
  @@index([isActive])
  @@map("countries")
}

model Service {
  id           String           @id @default(uuid())
  externalId   String           @map("external_id")
  name         String
  slug         String
  shortName    String?          @map("short_name")
  iconUrl      String?          @map("icon_url")
  senderTitle  String?          @map("sender_title")
  smsPattern   String?          @map("sms_pattern")
  popular      Int              @default(0)
  provider     String
  isActive     Boolean          @default(true) @map("is_active")
  lastSyncedAt DateTime         @default(now()) @map("last_synced_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  pricing      ServicePricing[]

  @@unique([externalId, provider])
  @@index([provider])
  @@index([isActive])
  @@map("services")
}

model ServicePricing {
  id            String   @id @default(uuid())
  countryId     String   @map("country_id")
  serviceId     String   @map("service_id")
  provider      String
  price         Decimal  @db.Decimal(8, 2)
  originalPrice Decimal? @map("original_price") @db.Decimal(8, 2)
  count         Int      @default(0)
  successRate   Decimal? @map("success_rate") @db.Decimal(5, 2)
  isAvailable   Boolean  @default(true) @map("is_available")
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  country       Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([countryId, serviceId, provider])
  @@index([provider])
  @@index([isAvailable])
  @@index([price])
  @@index([serviceId, isAvailable, price])  // Optimized pricing lookup
  @@index([countryId, isAvailable])         // Available services in country
  @@map("service_pricing")
}

model SyncJob {
  id          String    @id @default(uuid())
  provider    String
  providerId  String?   @map("provider_id")
  jobType     String    @map("job_type")
  status      String
  itemsFound  Int       @default(0) @map("items_found")
  itemsSynced Int       @default(0) @map("items_synced")
  error       String?
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  providerRel Provider? @relation(fields: [providerId], references: [id])

  @@index([provider])
  @@index([providerId])
  @@index([status])
  @@map("sync_jobs")
}

model Provider {
  id              String   @id @default(uuid())
  name            String   @unique // Internal slug (e.g., "5sim")
  displayName     String   @map("display_name")
  description     String?
  logoUrl         String?  @map("logo_url")
  websiteUrl      String?  @map("website_url")
  
  // --- API Configuration ---
  apiBaseUrl      String   @map("api_base_url")
  
  // Auth Config
  authType        String   @default("bearer") // enum: bearer, header, query_param, none
  providerType    String   @default("rest") @map("provider_type") // enum: rest, hybrid, sms-activate
  authKey         String?  @map("auth_key")   // Encrypted API Key
  authHeader      String?  @map("auth_header") // e.g., "Authorization", "X-API-KEY"
  authQueryParam  String?  @map("auth_query_param") // e.g., "api_key", "token"
  
  // --- Endpoint Definitions (JSON) ---
  endpoints       Json     
  
  // --- Response Mappings (JSON) ---
  mappings        Json     
  
  // --- Business Logic ---
  priceMultiplier Decimal  @default(1.0) @map("price_multiplier") @db.Decimal(5, 2)
  fixedMarkup     Decimal  @default(0.0) @map("fixed_markup") @db.Decimal(8, 2)
  currency        String   @default("USD")

  // --- Balance Alert ---
  balance         Decimal  @default(0.0) @db.Decimal(10, 2)
  lowBalanceAlert Decimal  @default(10.0) @map("low_balance_alert") @db.Decimal(10, 2)
  lastBalanceSync DateTime? @map("last_balance_sync")
  
  isActive        Boolean  @default(false) @map("is_active")
  priority        Int      @default(0) // Higher = tried first
  
  // --- Meta ---
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  syncJobs        SyncJob[]
  testResults     ProviderTestResult[]
  
  @@index([isActive])
  @@index([priority])
  @@map("providers")
}

model ProviderTestResult {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  action      String   // e.g., "getCountries", "getBalance"
  success     Boolean
  httpStatus  Int?     @map("http_status")
  responseTime Int?    @map("response_time") // ms
  requestUrl  String?  @map("request_url")
  responseData String? @db.Text @map("response_data")
  error       String?
  testedAt    DateTime @default(now()) @map("tested_at")
  
  provider    Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  @@index([providerId])
  @@map("provider_test_results")
}

enum Role {
  USER
  ADMIN
}
