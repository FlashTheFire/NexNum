generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  role         Role       @default(USER)
  isBanned     Boolean    @default(false) @map("is_banned")
  auditLogs    AuditLog[]
  numbers      Number[]
  wallet       Wallet?
  reservations OfferReservation[]

  @@map("users")
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique @map("user_id")
  createdAt    DateTime            @default(now()) @map("created_at")
  transactions WalletTransaction[]
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model WalletTransaction {
  id             String   @id @default(uuid())
  walletId       String   @map("wallet_id")
  amount         Decimal  @db.Decimal(12, 2)
  type           String
  description    String?
  idempotencyKey String?  @unique @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at")
  wallet         Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@map("wallet_transactions")
}

model Number {
  id           String       @id @default(uuid())
  phoneNumber  String       @map("phone_number")
  countryCode  String       @map("country_code")
  countryName  String?      @map("country_name")
  serviceName  String?      @map("service_name")
  serviceCode  String?      @map("service_code")
  price        Decimal      @db.Decimal(8, 2)
  status       String       @default("available")
  ownerId      String?      @map("owner_id")
  activationId String?      @map("activation_id")
  provider     String?
  idempotencyKey String?    @unique @map("idempotency_key") // For purchase safety
  expiresAt    DateTime?    @map("expires_at")
  purchasedAt  DateTime?    @map("purchased_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  owner        User?        @relation(fields: [ownerId], references: [id])
  smsMessages  SmsMessage[]

  @@index([ownerId])
  @@index([status])
  @@index([status, createdAt])           // List by status ordered by date
  @@index([ownerId, status])             // User's numbers by status
  @@index([provider, status])            // Provider stats
  @@index([expiresAt])                   // Expiring numbers cleanup
  @@map("numbers")
}

model SmsMessage {
  id         String   @id @default(uuid())
  numberId   String   @map("number_id")
  sender     String?
  content    String?
  code       String?
  receivedAt DateTime @default(now()) @map("received_at")
  number     Number   @relation(fields: [numberId], references: [id], onDelete: Cascade)

  @@index([numberId])
  @@map("sms_messages")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ============================================
// LOOKUP TABLES (Reference data for display)
// ============================================

// Service lookup: code → display details
model ServiceLookup {
  code     String  @id                // e.g., "wa", "tg", "fb"
  name     String                     // e.g., "WhatsApp"
  iconUrl  String? @map("icon_url")   // Optional icon/logo URL
  
  @@map("service_lookups")
}

// Country lookup: code → display details  
model CountryLookup {
  code      String  @id               // ISO code: "US", "IN", "GB"
  name      String                    // e.g., "United States"
  flagUrl   String? @map("flag_url")  // Flag image URL
  
  @@map("country_lookups")
}

// ============================================
// PROVIDER CONFIGURATION
// ============================================

model Provider {
  id              String   @id @default(uuid())
  name            String   @unique // Internal slug (e.g., "5sim")
  displayName     String   @map("display_name")
  description     String?
  logoUrl         String?  @map("logo_url")
  websiteUrl      String?  @map("website_url")
  
  // --- API Configuration ---
  apiBaseUrl      String   @map("api_base_url")
  
  // Auth Config
  authType        String   @default("bearer") // enum: bearer, header, query_param, none
  providerType    String   @default("rest") @map("provider_type") // enum: rest, hybrid, sms-activate
  authKey         String?  @map("auth_key")   // Encrypted API Key
  authHeader      String?  @map("auth_header") // e.g., "Authorization", "X-API-KEY"
  authQueryParam  String?  @map("auth_query_param") // e.g., "api_key", "token"
  
  // --- Endpoint Definitions (JSON) ---
  endpoints       Json     
  
  // --- Response Mappings (JSON) ---
  mappings        Json     
  
  // --- Business Logic ---
  priceMultiplier Decimal  @default(1.0) @map("price_multiplier") @db.Decimal(5, 2)
  fixedMarkup     Decimal  @default(0.0) @map("fixed_markup") @db.Decimal(8, 2)
  currency        String   @default("USD")

  // --- Balance Alert ---
  balance         Decimal  @default(0.0) @db.Decimal(10, 2)
  lowBalanceAlert Decimal  @default(10.0) @map("low_balance_alert") @db.Decimal(10, 2)
  lastBalanceSync DateTime? @map("last_balance_sync")
  
  isActive        Boolean  @default(false) @map("is_active")
  priority        Int      @default(0) // Higher = tried first
  
  // --- Sync tracking ---
  lastSyncAt      DateTime? @map("last_sync_at")
  syncStatus      String?   @map("sync_status") // syncing, success, failed, idle
  syncCount       Int       @default(0) @map("sync_count")
  
  // --- Metadata Caching (24h Rule) - DEPRECATED, will be removed ---
  lastMetadataSyncAt DateTime? @map("last_metadata_sync_at")
  cachedCountries    Json?     @map("cached_countries")
  cachedServices     Json?     @map("cached_services")

  // --- Meta ---
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // --- Relations ---
  testResults     ProviderTestResult[]
  countries       ProviderCountry[]
  services        ProviderService[]
  pricing         ProviderPricing[]
  
  @@index([isActive])
  @@index([priority])
  @@map("providers")
}

// ============================================
// PROVIDER-SPECIFIC DATA (No Merging)
// ============================================

// Provider-specific countries
model ProviderCountry {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  externalId  String   @map("external_id")  // Provider's ID (e.g., "2", "187", "us")
  code        String                        // Normalized code for internal use
  name        String                        // Display name (e.g., "Kazakhstan")
  flagUrl     String?  @map("flag_url")
  isActive    Boolean  @default(true) @map("is_active")
  lastSyncAt  DateTime @default(now()) @map("last_sync_at")
  
  provider    Provider          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  pricing     ProviderPricing[]
  
  @@unique([providerId, externalId])
  @@index([providerId])
  @@index([code])
  @@map("provider_countries")
}

// Provider-specific services
model ProviderService {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  externalId  String   @map("external_id")  // Provider's service code (e.g., "wa", "fb")
  code        String                        // Normalized code for internal use
  name        String                        // Display name (e.g., "WhatsApp")
  iconUrl     String?  @map("icon_url")
  isActive    Boolean  @default(true) @map("is_active")
  lastSyncAt  DateTime @default(now()) @map("last_sync_at")
  
  provider    Provider          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  pricing     ProviderPricing[]
  
  @@unique([providerId, externalId])
  @@index([providerId])
  @@index([code])
  @@map("provider_services")
}

// Provider-specific pricing (replaces MeiliSearch-only approach)
model ProviderPricing {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  countryId   String   @map("country_id")
  serviceId   String   @map("service_id")
  operator    String?                       // Optional operator code (e.g., "virtual21")
  cost        Decimal  @db.Decimal(8, 4)    // Raw cost from provider API
  providerRawCost Decimal? @db.Decimal(8, 6) @map("provider_raw_cost") // Original provider cost for reconciliation
  sellPrice   Decimal  @db.Decimal(8, 2)    // After markup applied
  stock       Int      @default(0)
  deleted     Boolean  @default(false)      // Soft delete for sync
  lastSyncAt  DateTime @default(now()) @map("last_sync_at")
  
  provider    Provider        @relation(fields: [providerId], references: [id], onDelete: Cascade)
  country     ProviderCountry @relation(fields: [countryId], references: [id], onDelete: Cascade)
  service     ProviderService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  reservations OfferReservation[]
  
  @@unique([providerId, countryId, serviceId, operator])
  @@index([providerId])
  @@index([countryId])
  @@index([serviceId])
  @@index([sellPrice])
  @@index([stock])
  @@map("provider_pricing")
}

model ProviderTestResult {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  action      String   // e.g., "getCountries", "getBalance"
  success     Boolean
  httpStatus  Int?     @map("http_status")
  responseTime Int?    @map("response_time") // ms
  requestUrl  String?  @map("request_url")
  responseData String? @db.Text @map("response_data")
  error       String?
  testedAt    DateTime @default(now()) @map("tested_at")
  
  provider    Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  @@index([providerId])
  @@map("provider_test_results")
}

enum Role {
  USER
  ADMIN
}

// ============================================
// SPRINT 0: OUTBOX PATTERN (Reliable Indexing)
// ============================================

// Outbox events for guaranteed MeiliSearch sync
model OutboxEvent {
  id            BigInt   @id @default(autoincrement())
  aggregateType String   @map("aggregate_type")  // "offer", "order", "provider"
  aggregateId   String   @map("aggregate_id")    // UUID of the entity
  eventType     String   @map("event_type")      // "offer.created", "offer.updated", "offer.deleted"
  payload       Json                             // Full event data
  processed     Boolean  @default(false)
  processedAt   DateTime? @map("processed_at")
  retryCount    Int      @default(0) @map("retry_count")
  error         String?                          // Last error message if failed
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@index([processed, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("outbox_events")
}

// ============================================
// SPRINT 1: OFFER RESERVATIONS (Purchase Safety)
// ============================================

// Reservation for preventing double-sells
model OfferReservation {
  id             String   @id @default(uuid())
  pricingId      String   @map("pricing_id")      // Reference to ProviderPricing
  userId         String   @map("user_id")
  quantity       Int      @default(1)
  expiresAt      DateTime @map("expires_at")      // TTL for reservation
  status         ReservationStatus @default(PENDING)
  idempotencyKey String?  @unique @map("idempotency_key")
  providerReservationId String? @map("provider_reservation_id") // If provider supports reservations
  createdAt      DateTime @default(now()) @map("created_at")
  confirmedAt    DateTime? @map("confirmed_at")
  
  user           User     @relation(fields: [userId], references: [id])
  pricing        ProviderPricing @relation(fields: [pricingId], references: [id])
  
  @@index([userId])
  @@index([pricingId])
  @@index([status, expiresAt])
  @@map("offer_reservations")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED
}

// ============================================
// SERVICE AGGREGATES (Precomputed for fast list)
// ============================================

model ServiceAggregate {
  id            String   @id @default(uuid())
  serviceCode   String   @unique @map("service_code") // "wa", "tg"
  serviceName   String   @map("service_name")         // "WhatsApp"
  lowestPrice   Decimal  @map("lowest_price") @db.Decimal(8, 2)
  totalStock    BigInt   @map("total_stock")
  countryCount  Int      @map("country_count")
  providerCount Int      @map("provider_count")
  lastUpdatedAt DateTime @default(now()) @map("last_updated_at")
  
  @@index([lowestPrice])
  @@map("service_aggregates")
}

