generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  passwordHash            String                   @map("password_hash")
  name                    String
  googleId                String?                  @unique @map("google_id")
  image                   String?
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  role                    Role                     @default(USER)
  isBanned                Boolean                  @default(false) @map("is_banned")
  emailVerified           DateTime?                @map("email_verified")
  tokenVersion            Int                      @default(1) @map("token_version")
  preferredCurrency       String?                  @map("preferred_currency") // e.g. "USD", "EUR", "POINTS"
  
  // 2FA Fields
  twoFactorEnabled      Boolean  @default(false)
  twoFactorSecret       String?
  twoFactorBackupCodes  String[] @default([])

  auditLogs               AuditLog[]
  numbers                 Number[]
  wallet                  Wallet?
  reservations            OfferReservation[]
  purchaseOrders          PurchaseOrder[]
  notifications           Notification[]
  pushSubscriptions       PushSubscription[]
  notificationPreferences NotificationPreferences?
  apiKeys                 ApiKey[]
  webhooks                Webhook[]
  passwordResets          PasswordReset[]
  emailVerificationTokens EmailVerificationToken[]

  @@map("users")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String // sms_received, payment_success, number_expiring, welcome, etc.
  title     String
  message   String
  data      Json? // Additional context (numberId, amount, etc.)
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model NotificationPreferences {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Channels
  emailEnabled Boolean @default(true) @map("email_enabled")
  pushEnabled  Boolean @default(true) @map("push_enabled")
  smsEnabled   Boolean @default(false) @map("sms_enabled")

  // Categories
  smsReceived Boolean @default(true) @map("sms_received")
  promotions  Boolean @default(true)
  billing     Boolean @default(true)
  security    Boolean @default(true)
  system      Boolean @default(true)

  // Customization
  soundEnabled Boolean @default(true) @map("sound_enabled")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique @map("user_id")
  balance      Decimal             @default(0.00) @db.Decimal(12, 2)
  reserved     Decimal             @default(0.00) @db.Decimal(12, 2)
  createdAt    DateTime            @default(now()) @map("created_at")
  transactions WalletTransaction[]
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model WalletTransaction {
  id             String   @id @default(uuid())
  walletId       String   @map("wallet_id")
  amount         Decimal  @db.Decimal(12, 2)
  type           String
  description    String?
  idempotencyKey String?  @unique @map("idempotency_key")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  wallet         Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@map("wallet_transactions")
}

model PurchaseOrder {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  serviceName    String   @map("service_name")
  countryName    String   @map("country_name")
  amount         Decimal  @db.Decimal(8, 2)
  status         String // PENDING, COMPLETED, FAILED
  provider       String?
  activationId   String?  @map("activation_id")
  idempotencyKey String?  @unique @map("idempotency_key")
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, expiresAt])
  @@index([userId])
  @@map("purchase_orders")
}

model Number {
  id                   String       @id @default(uuid())
  phoneNumber          String       @map("phone_number")
  phoneCountryCode     String?      @map("phone_country_code")    // Phone country code (e.g., "+1", "+91")
  phoneNationalNumber  String?      @map("phone_national_number") // National number without country code
  countryCode          String       @map("country_code")
  countryName          String?      @map("country_name")
  countryIconUrl       String?      @map("country_icon_url")
  serviceName          String?      @map("service_name")
  serviceCode          String?      @map("service_code")
  serviceIconUrl       String?      @map("service_icon_url")
  price                Decimal      @db.Decimal(8, 2)
  status               String       @default("available")
  ownerId              String?      @map("owner_id")
  activationId         String?      @map("activation_id")
  provider             String?
  idempotencyKey       String?      @unique @map("idempotency_key") // For purchase safety
  expiresAt      DateTime?    @map("expires_at")
  purchasedAt    DateTime?    @map("purchased_at")
  pollCount      Int          @default(0) @map("poll_count")
  nextPollAt     DateTime?    @default(now()) @map("next_poll_at")
  lastPolledAt   DateTime?    @map("last_polled_at")
  errorCount     Int          @default(0) @map("error_count")
  lastError      String?      @map("last_error")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime?    @updatedAt @map("updated_at")
  owner          User?        @relation(fields: [ownerId], references: [id])
  smsMessages    SmsMessage[]

  @@index([ownerId])
  @@index([status])
  @@index([status, createdAt]) // List by status ordered by date
  @@index([ownerId, status]) // User's numbers by status
  @@index([provider, status]) // Provider stats
  @@index([expiresAt]) // Expiring numbers cleanup
  @@map("numbers")
}

model SmsMessage {
  id         String   @id @default(uuid())
  numberId   String   @map("number_id")
  sender     String?
  content    String?
  code       String?
  receivedAt DateTime @default(now()) @map("received_at")

  // Enhanced fields for advanced tracking
  provider      String? // Provider that received the SMS
  rawPayload    Json?    @map("raw_payload") // Original provider response
  extractedCode String?  @map("extracted_code") // Code from extractor
  confidence    Decimal? @db.Decimal(3, 2) // Extraction confidence (0-1)

  number Number @relation(fields: [numberId], references: [id], onDelete: Cascade)

  @@index([numberId])
  @@index([provider])
  @@map("sms_messages")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// ============================================
// LOOKUP TABLES (Reference data for display)
// ============================================

// Service lookup: code → display details
model ServiceLookup {
  code    String  @id // e.g., "wa", "tg", "fb"
  name    String // e.g., "WhatsApp"
  iconUrl String? @map("icon_url") // Optional icon/logo URL

  @@map("service_lookups")
}

// Country lookup: code → display details  
model CountryLookup {
  code    String  @id // ISO code: "US", "IN", "GB"
  name    String // e.g., "United States"
  flagUrl String? @map("flag_url") // Flag image URL

  @@map("country_lookups")
}

// ============================================
// PROVIDER CONFIGURATION
// ============================================

model Provider {
  id          String  @id @default(uuid())
  name        String  @unique // Internal slug (e.g., "5sim")
  displayName String  @map("display_name")
  description String?
  logoUrl     String? @map("logo_url")
  websiteUrl  String? @map("website_url")

  // --- API Configuration ---
  apiBaseUrl String @map("api_base_url")

  // Auth Config
  authType       String  @default("bearer") // enum: bearer, header, query_param, none
  providerType   String  @default("rest") @map("provider_type") // enum: rest, hybrid, sms-activate
  authKey        String? @map("auth_key") // Encrypted API Key
  authHeader     String? @map("auth_header") // e.g., "Authorization", "X-API-KEY"
  authQueryParam String? @map("auth_query_param") // e.g., "api_key", "token"

  // --- Endpoint Definitions (JSON) ---
  endpoints Json

  // --- Response Mappings (JSON) ---
  mappings Json

  // --- Business Logic ---
  useDynamicMetadata Boolean @default(false) @map("use_dynamic_metadata")
  dynamicFunctions   Json?   @map("dynamic_functions") // e.g. ["getPrices", "getCountries"]

  priceMultiplier Decimal @default(1.0) @map("price_multiplier") @db.Decimal(5, 2)
  fixedMarkup     Decimal @default(0.0) @map("fixed_markup") @db.Decimal(8, 2)
  currency        String  @default("USD")

  // --- Advanced Normalization ---
  normalizationMode String  @default("AUTO") @map("normalization_mode") // enum: AUTO, MANUAL, API, SMART_AUTO
  normalizationRate Decimal? @map("normalization_rate") @db.Decimal(18, 8)
  apiPair           String? @map("api_pair") // e.g., "USDT/RUB"
  depositSpent     Decimal? @map("deposit_spent") @db.Decimal(18, 8)
  depositReceived  Decimal? @map("deposit_received") @db.Decimal(18, 8)
  depositCurrency  String   @default("USD") @map("deposit_currency")

  // --- Balance Alert ---
  balance         Decimal   @default(0.0) @db.Decimal(10, 2)
  lowBalanceAlert Decimal   @default(10.0) @map("low_balance_alert") @db.Decimal(10, 2)
  lastBalanceSync DateTime? @map("last_balance_sync")

  isActive Boolean @default(false) @map("is_active")
  priority Int     @default(0) // Higher = tried first

  // --- Sync tracking ---
  lastSyncAt DateTime? @map("last_sync_at")
  syncStatus String?   @map("sync_status") // syncing, success, failed, idle
  syncCount  Int       @default(0) @map("sync_count")

  // --- Metadata Caching (24h Rule) - DEPRECATED, will be removed ---
  lastMetadataSyncAt DateTime? @map("last_metadata_sync_at")
  cachedCountries    Json?     @map("cached_countries")
  cachedServices     Json?     @map("cached_services")

  // --- Meta ---
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // --- Relations ---
  testResults ProviderTestResult[]
  countries   ProviderCountry[]
  services    ProviderService[]
  pricing     ProviderPricing[]
  healthLogs  ProviderHealthLog[]

  @@index([isActive])
  @@index([priority])
  @@index([isActive, priority]) // Fast selection of active providers ordered by priority
  @@map("providers")
}

// ============================================
// PROVIDER-SPECIFIC DATA (No Merging)
// ============================================

// Provider-specific countries
model ProviderCountry {
  id         String   @id @default(uuid())
  providerId String   @map("provider_id")
  externalId String   @map("external_id") // Provider's ID (e.g., "2", "187", "us")
  code       String // Normalized code for internal use
  name       String // Display name (e.g., "Kazakhstan")
  flagUrl    String?  @map("flag_url")
  isActive   Boolean  @default(true) @map("is_active")
  lastSyncAt DateTime @default(now()) @map("last_sync_at")

  provider Provider          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  pricing  ProviderPricing[]

  @@unique([providerId, externalId])
  @@index([providerId])
  @@index([code])
  @@map("provider_countries")
}

// Provider-specific services
model ProviderService {
  id         String   @id @default(uuid())
  providerId String   @map("provider_id")
  externalId String   @map("external_id") // Provider's service code (e.g., "wa", "fb")
  code       String // Normalized code for internal use
  name       String // Display name (e.g., "WhatsApp")
  iconUrl    String?  @map("icon_url")
  isActive   Boolean  @default(true) @map("is_active")
  lastSyncAt DateTime @default(now()) @map("last_sync_at")

  provider Provider          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  pricing  ProviderPricing[]

  @@unique([providerId, externalId])
  @@index([providerId])
  @@index([code])
  @@map("provider_services")
}

// Provider-specific pricing (replaces MeiliSearch-only approach)
model ProviderPricing {
  id              String   @id @default(uuid())
  providerId      String   @map("provider_id")
  countryId       String   @map("country_id")
  serviceId       String   @map("service_id")
  operator        String? // Optional operator code (e.g., "virtual21")
  cost            Decimal  @db.Decimal(8, 4) // Raw cost from provider API
  providerRawCost Decimal? @map("provider_raw_cost") @db.Decimal(8, 6) // Original provider cost for reconciliation
  sellPrice       Decimal  @db.Decimal(8, 2) // After markup applied
  stock           Int      @default(0)
  deleted         Boolean  @default(false) // Soft delete for sync
  lastSyncAt      DateTime @default(now()) @map("last_sync_at")

  provider     Provider           @relation(fields: [providerId], references: [id], onDelete: Cascade)
  country      ProviderCountry    @relation(fields: [countryId], references: [id], onDelete: Cascade)
  service      ProviderService    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  reservations OfferReservation[]

  @@unique([providerId, countryId, serviceId, operator])
  @@index([providerId])
  @@index([countryId])
  @@index([serviceId])
  @@index([sellPrice])
  @@index([stock])
  @@index([deleted, stock, serviceId]) // Aggregate calculation speedup
  @@map("provider_pricing")
}

model ProviderTestResult {
  id           String   @id @default(uuid())
  providerId   String   @map("provider_id")
  action       String // e.g., "getCountries", "getBalance"
  success      Boolean
  httpStatus   Int?     @map("http_status")
  responseTime Int?     @map("response_time") // ms
  requestUrl   String?  @map("request_url")
  responseData String?  @map("response_data") @db.Text
  error        String?
  testedAt     DateTime @default(now()) @map("tested_at")

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@map("provider_test_results")
}

// Provider health monitoring logs
model ProviderHealthLog {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  status      String // healthy, degraded, down
  successRate Decimal  @db.Decimal(5, 2)
  avgLatency  Int // ms
  errorCount  Int      @default(0)
  checkedAt   DateTime @default(now()) @map("checked_at")

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, checkedAt])
  @@map("provider_health_logs")
}

// Webhook events tracking
model WebhookEvent {
  id             String    @id @default(uuid())
  provider       String
  eventType      String    @map("event_type")
  payload        Json
  idempotencyKey String    @unique @map("idempotency_key")
  processed      Boolean   @default(false)
  processedAt    DateTime? @map("processed_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([provider, createdAt])
  @@index([processed])
  @@map("webhook_events")
}

enum Role {
  USER
  ADMIN
}

// ============================================
// SPRINT 0: OUTBOX PATTERN (Reliable Indexing)
// ============================================

// Outbox events for guaranteed MeiliSearch sync
// Outbox events for guaranteed sync and reliable messaging
model OutboxEvent {
  id            String   @id @default(uuid())
  aggregateId   String   @map("aggregate_id")
  aggregateType String   @map("aggregate_type")
  eventType     String   @map("event_type")
  payload       Json
  status        String   @default("PENDING") // PENDING, PUBLISHED, FAILED
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  error         String?
  retryCount    Int      @default(0) @map("retry_count")

  @@index([status, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("outbox_events_v2")
}

// ============================================
// SPRINT 1: OFFER RESERVATIONS (Purchase Safety)
// ============================================

// Reservation for preventing double-sells
model OfferReservation {
  id                    String            @id @default(uuid())
  pricingId             String            @map("pricing_id") // Reference to ProviderPricing
  userId                String            @map("user_id")
  quantity              Int               @default(1)
  expiresAt             DateTime          @map("expires_at") // TTL for reservation
  status                ReservationStatus @default(PENDING)
  idempotencyKey        String?           @unique @map("idempotency_key")
  providerReservationId String?           @map("provider_reservation_id") // If provider supports reservations
  createdAt             DateTime          @default(now()) @map("created_at")
  confirmedAt           DateTime?         @map("confirmed_at")

  user    User            @relation(fields: [userId], references: [id])
  pricing ProviderPricing @relation(fields: [pricingId], references: [id])

  @@index([userId])
  @@index([pricingId])
  @@index([status, expiresAt])
  @@map("offer_reservations")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED
}

// ============================================
// SERVICE AGGREGATES (Precomputed for fast list)
// ============================================

model ServiceAggregate {
  id            String   @id @default(uuid())
  serviceCode   String   @unique @map("service_code") // "wa", "tg"
  serviceName   String   @map("service_name") // "WhatsApp"
  lowestPrice   Decimal  @map("lowest_price") @db.Decimal(8, 2)
  totalStock    BigInt   @map("total_stock")
  countryCount  Int      @map("country_count")
  providerCount Int      @map("provider_count")
  lastUpdatedAt DateTime @default(now()) @map("last_updated_at")

  @@index([lowestPrice])
  @@index([totalStock]) // Sort by stock
  @@index([serviceName]) // Sort by name
  @@map("service_aggregates")
}

// ============================================
// ACTIVATION STATE MACHINE (Phase 11)
// ============================================

enum ActivationState {
  INIT
  RESERVED
  ACTIVE
  RECEIVED
  EXPIRED
  CANCELLED
  FAILED
  REFUNDED
}

model Activation {
  id     String          @id @default(uuid())
  userId String          @map("user_id")
  state  ActivationState @default(RESERVED)
  price  Decimal         @db.Decimal(8, 2)

  // Wallet Transaction References
  reservedTxId String? @map("reserved_tx_id")
  capturedTxId String? @map("captured_tx_id")
  refundTxId   String? @map("refund_tx_id")

  // Provider Info
  providerActivationId String? @map("provider_activation_id")
  providerId           String? @map("provider_id")

  // Request Details
  serviceName String  @map("service_name")
  countryCode String  @map("country_code")
  countryName String? @map("country_name")
  operatorId  String? @map("operator_id")

  // Result (populated on ACTIVE)
  phoneNumber String?   @map("phone_number")
  expiresAt   DateTime? @map("expires_at")

  // Linked Number (if created)
  numberId String? @unique @map("number_id")

  // Idempotency
  idempotencyKey String? @unique @map("idempotency_key")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([state])
  @@index([state, createdAt])
  @@index([providerId])
  @@map("activations")
}

// ============================================
// PROVIDER EVENTS (Webhook Store)
// ============================================

model ProviderEvent {
  id              String    @id @default(uuid())
  providerEventId String    @unique @map("provider_event_id") // Provider's event ID (idempotency)
  providerId      String    @map("provider_id")
  activationId    String?   @map("activation_id")
  eventType       String    @map("event_type") // e.g., "sms", "expired", "cancelled"
  payload         Json
  processed       Boolean   @default(false)
  processedAt     DateTime? @map("processed_at")
  receivedAt      DateTime  @default(now()) @map("received_at")

  @@index([activationId])
  @@index([processed])
  @@map("provider_events")
}

// ============================================
// CURRENCY & SETTINGS
// ============================================

model Currency {
  code          String   @id // USD, EUR, INR, RUB
  name          String   // US Dollar, Euro
  symbol        String   // $, €, ₹
  rate          Decimal  @db.Decimal(10, 4) // Exchange rate relative to Base Anchor (USD)
  isBase        Boolean  @default(false) @map("is_base") // Is this the technical anchor? (usually USD)
  isActive      Boolean  @default(true) @map("is_active")
  autoUpdate    Boolean  @default(true) @map("auto_update") // Should we auto-update this rate?
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("currencies")
}

model SystemSettings {
  id              String  @id @default("default")

  // Currency Logic
  baseCurrency    String  @default("USD") @map("base_currency") // The technical anchor (e.g., USD)
  displayCurrency String  @default("USD") @map("display_currency") // Default for new users (e.g., POINTS)

  // Points System (if active)
  pointsEnabled   Boolean @default(false) @map("points_enabled")
  pointsName      String  @default("Points") @map("points_name")
  pointsRate      Decimal @default(100.0) @map("points_rate") // 1 USD = 100 Points

  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

// ============================================
// API KEY & WEBHOOK SYSTEM
// ============================================

model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String    // Human-readable name ("Production Key", "Test Key")
  keyHash     String    @unique @map("key_hash") // SHA-256 hash of full key
  prefix      String    // First 8 chars for identification (e.g., "nxn_live_")
  permissions String[]  // ["read", "write", "numbers", "sms", "wallet"]
  tier        ApiTier   @default(FREE)
  rateLimit   Int       @default(60) @map("rate_limit") // requests per minute
  usageCount  BigInt    @default(0) @map("usage_count") // total lifetime usage
  lastUsedAt  DateTime? @map("last_used_at")
  lastUsedIp  String?   @map("last_used_ip")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  ipWhitelist String[]  @map("ip_whitelist") // Empty = allow all
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([prefix])
  @@index([isActive])
  @@map("api_keys")
}

enum ApiTier {
  FREE       // 60 req/min, basic features
  PRO        // 300 req/min, all features
  ENTERPRISE // 1000 req/min, priority support
}

model Webhook {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  url         String    // HTTPS endpoint
  secret      String    // For HMAC-SHA256 signing
  events      String[]  // ["sms.received", "number.expired", "balance.low"]
  isActive    Boolean   @default(true) @map("is_active")
  failCount   Int       @default(0) @map("fail_count") // Consecutive failures
  lastTriedAt DateTime? @map("last_tried_at")
  lastSuccessAt DateTime? @map("last_success_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([userId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String   @id @default(uuid())
  webhookId    String   @map("webhook_id")
  event        String   // e.g., "sms.received"
  payload      Json     // Full event payload
  status       String   @default("pending") // pending, delivered, failed
  responseCode Int?     @map("response_code")
  responseBody String?  @map("response_body") @db.Text
  durationMs   Int?     @map("duration_ms")
  attempts     Int      @default(0)
  nextRetryAt  DateTime? @map("next_retry_at")
  createdAt    DateTime @default(now()) @map("created_at")
  deliveredAt  DateTime? @map("delivered_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}

model PasswordReset {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique // Secure random token
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  ipAddress String?   @map("ip_address")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_resets")
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

// ============================================
// ASSET MANAGEMENT
// ============================================

model BannedIcon {
  id          String   @id @default(uuid())
  hash        String   @unique // SHA-256 Hash
  description String?  // Reason or name (e.g., "5sim Bad Bear")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("banned_icons")
}
