# =============================================================================
# ALERTMANAGER CONFIGURATION
# =============================================================================
# 
# Routes alerts from Prometheus to notification channels.
# 
# Supported Channels:
#   - Telegram (via webhook)
#   - Email (SMTP)
#   - Slack (webhook)
#   - PagerDuty
#
# =============================================================================

global:
  resolve_timeout: 5m
  # SMTP configuration for email alerts
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@nexnum.com'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASS}'
  smtp_require_tls: true

# Inhibition rules prevent redundant alerts
inhibit_rules:
  # If critical is firing, suppress warnings for same alert
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname']
  
  # If API is down, suppress all other alerts
  - source_match:
      alertname: 'APIDown'
    target_match_re:
      alertname: '.+'
    equal: []

# Routing tree
route:
  # Default receiver
  receiver: 'telegram-alerts'
  
  # Group alerts by these labels
  group_by: ['alertname', 'severity']
  
  # Wait before first notification
  group_wait: 30s
  
  # Wait before sending updates
  group_interval: 5m
  
  # Wait before resending
  repeat_interval: 4h

  # Sub-routes for different severities
  routes:
    # Critical alerts: Page immediately
    - match:
        severity: critical
      receiver: 'telegram-critical'
      group_wait: 10s
      repeat_interval: 1h
      continue: true  # Also send to email

    # Warning alerts: Normal notification
    - match:
        severity: warning
      receiver: 'telegram-alerts'
      group_wait: 1m
      repeat_interval: 4h

    # Security alerts: Special handling
    - match:
        team: security
      receiver: 'telegram-critical'
      group_wait: 15s

# =============================================================================
# RECEIVERS
# =============================================================================
receivers:
  # ---------------------------------------------------------------------------
  # TELEGRAM (via Prometheus Alertmanager Telegram Bot or webhook)
  # ---------------------------------------------------------------------------
  # Option 1: Use alertmanager-telegram-bot (recommended)
  # https://github.com/metalmatze/alertmanager-bot
  
  - name: 'telegram-alerts'
    webhook_configs:
      - url: 'http://host.docker.internal:3000/api/alerts/telegram'
        send_resolved: true
        http_config:
          bearer_token: '${ALERT_WEBHOOK_SECRET}'

  - name: 'telegram-critical'
    webhook_configs:
      - url: 'http://host.docker.internal:3000/api/alerts/telegram'
        send_resolved: true
        http_config:
          bearer_token: '${ALERT_WEBHOOK_SECRET}'
    email_configs:
      - to: '${ALERT_EMAIL}'
        send_resolved: true
        headers:
          Subject: 'ðŸš¨ [CRITICAL] {{ .GroupLabels.alertname }}'
        html: |
          <h2>{{ .Status | toUpper }}</h2>
          <table>
          {{ range .Alerts }}
            <tr>
              <td><strong>{{ .Labels.alertname }}</strong></td>
              <td>{{ .Annotations.summary }}</td>
            </tr>
          {{ end }}
          </table>

  # ---------------------------------------------------------------------------
  # FALLBACK: Console logging only
  # ---------------------------------------------------------------------------
  - name: 'default-log'
    # No configuration = alerts logged to Alertmanager stdout

# =============================================================================
# TEMPLATES (optional)
# =============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'
