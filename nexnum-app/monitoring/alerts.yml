# =============================================================================
# NEXNUM INDUSTRIAL ALERT RULES (v2.0)
# =============================================================================

groups:
  # ===========================================================================
  # âš¡ API & APPLICATION HEALTH
  # ===========================================================================
  - name: api_reliability
    interval: 15s
    rules:
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(nexnum_http_requests_total{status_code=~"5.."}[5m])) /
            sum(rate(nexnum_http_requests_total[5m]))
          ) * 100 > 5
        for: 2m
        labels:
          severity: critical
          tier: api
        annotations:
          summary: "ðŸš¨ High API error rate ({{ printf \"%.1f\" $value }}%)"
          description: "NexNum API is returning internal errors. Check logs for trace IDs."

      - alert: CriticalLatency
        expr: |
          histogram_quantile(0.99, sum(rate(nexnum_http_request_duration_seconds_bucket[5m])) by (le)) > 5
        for: 2m
        labels:
          severity: critical
          tier: api
        annotations:
          summary: "ðŸ¢ Critical API Latency (P99: {{ printf \"%.2f\" $value }}s)"
          description: "API response time is extremely high. Possible DB Lock contention."

  # ===========================================================================
  # ðŸ’° BUSINESS & FINANCIAL INTEGRITY (Critical)
  # ===========================================================================
  - name: business_integrity
    interval: 30s
    rules:
      - alert: WalletInconsistencyDetected
        expr: |
          sum(nexnum_wallet_balance_cache_mismatch_total) > 0
        for: 1m
        labels:
          severity: critical
          tier: financial
        annotations:
          summary: "âš–ï¸ WALLET INTEGRITY FAILURE"
          description: "Discrepancy detected between user balance cache and transaction ledger. Manual audit required."

      - alert: ProviderSyncFailed
        expr: |
          time() - nexnum_provider_last_sync_timestamp > 86400
        for: 15m
        labels:
          severity: warning
          tier: platform
        annotations:
          summary: "ðŸ“¡ Provider Sync Lag"
          description: "Provider pricing hasn't synced in 24 hours. Catalog may be stale."

  # ===========================================================================
  # âš™ï¸ WORKER & PERF
  # ===========================================================================
  - name: worker_health
    interval: 30s
    rules:
      - alert: QueueExhaustion
        expr: |
          sum(nexnum_worker_queue_depth{state="pending"}) > 500
        for: 5m
        labels:
          severity: critical
          tier: backend
        annotations:
          summary: "ðŸš¨ Queue Exhaustion"
          description: "Pending jobs > 500 for 5m. Workers cannot keep up with traffic."

  # ===========================================================================
  # ðŸ’¾ INFRASTRUCTURE
  # ===========================================================================
  - name: infra_hardened
    interval: 30s
    rules:
      - alert: DiskSpaceLow
        expr: nexnum_system_disk_usage_percent > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ðŸ’½ Disk Space Low"
          description: "Host disk usage > 85%. Prune Docker images/logs immediately."

  # ===========================================================================
  # âš–ï¸ EXECUTIVE & COMPLIANCE
  # ===========================================================================
  - name: executive_control
    interval: 1m
    rules:
      - alert: ZombieWorkerDetection
        expr: |
          sum(nexnum_worker_queue_depth{state="pending"}) > 0 and
          sum(rate(nexnum_worker_jobs_processed_total[10m])) == 0
        for: 5m
        labels:
          severity: critical
          tier: operations
        annotations:
          summary: "ðŸ§Ÿ ZOMBIE WORKERS"
          description: "Pending jobs exist but processing rate is zero. Workers are likely hung or dead."

      - alert: FinancialAnomalyRefundRate
        expr: |
          sum(increase(nexnum_wallet_refunds_total[1h])) > 
          sum(increase(nexnum_wallet_deposits_total[1h])) * 0.5
        for: 15m
        labels:
          severity: critical
          tier: security
        annotations:
          summary: "ðŸ’¸ Financial Anomaly: High Refund Rate"
          description: "Refunds have exceeded 50% of deposits in the last hour. Possible attack or system failure."

      - alert: SLABreachLatency
        expr: |
          histogram_quantile(0.99, sum(rate(nexnum_http_request_duration_seconds_bucket[24h])) by (le)) > 3
        for: 1h
        labels:
          severity: warning
          tier: executive
        annotations:
          summary: "ðŸ“‰ 24h SLA Warning"
          description: "P99 latency has exceeded 3s over a 24-hour window. Performance is trending downwards."
