groups:
- name: nexnum-alerts
  rules:
  - alert: HighPurchaseFailureRate
    expr: |
      sum(rate(nexnum_wallet_transactions_total{status=~"fail.*"}[5m])) 
      / 
      sum(rate(nexnum_wallet_transactions_total[5m])) > 0.1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: High purchase failure rate detected (>10%)
      description: Check logs for provider issues or wallet insufficient funds spikes.

  - alert: ProviderApiErrors
    expr: rate(nexnum_provider_api_calls_total{status="error"}[5m]) > 0.5
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: Provider API returning errors
      description: Rate of provider errors > 0.5 req/s.

  - alert: StuckReservations
    expr: nexnum_reservation_stuck_count > 5
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: Stuck Purchase Orders detected
      description: Reconciler is finding stuck orders > 5 consistently. Check Reconciler Cron.

  - alert: HighPurchaseLatency
    expr: histogram_quantile(0.95, rate(nexnum_purchase_duration_seconds_bucket[5m])) > 5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: P95 Purchase Latency > 5s
      description: Users are waiting too long. Check Provider API latency.
